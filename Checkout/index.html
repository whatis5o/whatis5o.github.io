<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - AfriStay</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Oleo+Script+Swash+Caps:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/Style/style.css">
    <style>
        :root { --primary: #EB6753; }
        body { background: #f5f5f5; }

        .page-body { max-width: 980px; margin: 0 auto; padding: 110px 24px 80px; }
        .page-title { font-size: 30px; font-weight: 800; color: #1a1a1a; margin-bottom: 6px; }
        .page-sub { color: #bbb; font-size: 15px; margin-bottom: 36px; }

        .breadcrumb { display: flex; align-items: center; gap: 8px; color: #bbb; font-size: 13px; margin-bottom: 28px; }
        .breadcrumb a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .breadcrumb a:hover { opacity: 0.75; }
        .breadcrumb i { font-size: 10px; color: #ddd; }

        .checkout-grid { display: grid; grid-template-columns: 1fr 340px; gap: 32px; align-items: start; }

        /* ── FORM CARDS ── */
        .form-card { background: #fff; border-radius: 20px; padding: 28px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); margin-bottom: 22px; }
        .form-card h2 { font-size: 17px; font-weight: 700; color: #1a1a1a; margin-bottom: 22px; display: flex; align-items: center; gap: 10px; }
        .form-card h2 i { color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group { margin-bottom: 18px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 13px 16px; border-radius: 12px;
            border: 1.5px solid #ebebeb; font-size: 14px;
            font-family: 'Inter', sans-serif; color: #222;
            outline: none; transition: border-color 0.2s; background: #fff;
        }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); }
        .date-hint { font-size: 12px; color: #ccc; margin-top: 5px; }

        /* ── PAYMENT OPTIONS ── */
        .pay-options { display: flex; flex-direction: column; gap: 12px; }
        .pay-option { display: flex; align-items: center; gap: 14px; padding: 14px 18px; border-radius: 14px; border: 2px solid #ebebeb; cursor: pointer; transition: all 0.2s; }
        .pay-option:hover { border-color: var(--primary); background: #fff9f8; }
        .pay-option.selected { border-color: var(--primary); background: #fff4f3; }
        .pay-option input[type=radio] { accent-color: var(--primary); width: 16px; height: 16px; flex-shrink: 0; }
        .pay-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .pay-icon.momo { background: #FFD700; color: #333; }
        .pay-icon.airtel { background: #e01a22; color: #fff; }
        .pay-icon.cash { background: #2ecc71; color: #fff; }
        .pay-info .pay-name { font-size: 14px; font-weight: 700; color: #222; }
        .pay-info .pay-desc { font-size: 12px; color: #aaa; }

        .submit-btn {
            width: 100%; padding: 16px; background: var(--primary); color: #fff;
            border: none; border-radius: 14px; font-size: 16px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 24px; transition: all 0.3s;
        }
        .submit-btn:hover:not(:disabled) { transform: translateY(-2px); filter: drop-shadow(0 6px 18px rgba(235,103,83,0.45)); }
        .submit-btn:disabled { opacity: 0.42; cursor: not-allowed; }

        /* ── SUMMARY CARD ── */
        .summary-card { background: #fff; border-radius: 20px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); padding: 24px; position: sticky; top: 100px; }
        .summary-img-wrap { width: 100%; height: 170px; border-radius: 14px; overflow: hidden; background: #f0f0f0; margin-bottom: 18px; display: flex; align-items: center; justify-content: center; }
        .summary-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .summary-title { font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 6px; line-height: 1.3; }
        .summary-loc { font-size: 13px; color: #bbb; display: flex; align-items: center; gap: 6px; margin-bottom: 20px; }
        .summary-loc i { color: var(--primary); }
        .summary-divider { height: 1px; background: #f2f2f2; margin: 14px 0; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #666; margin-bottom: 10px; }
        .summary-row .val { font-weight: 600; color: #333; }
        .summary-row.total { font-size: 16px; font-weight: 800; color: #1a1a1a; margin-top: 4px; }
        .summary-row.total .val { color: var(--primary); font-size: 22px; }
        .duration-badge { display: inline-flex; align-items: center; gap: 6px; background: #fff4f3; color: var(--primary); font-size: 12px; font-weight: 700; padding: 5px 12px; border-radius: 20px; margin-bottom: 18px; }

        /* ── SUCCESS MODAL ── */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 9999; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: #fff; border-radius: 24px; padding: 52px 42px; text-align: center; max-width: 420px; width: 92%; animation: popIn 0.4s ease; }
        @keyframes popIn { from{opacity:0;transform:scale(0.8)} to{opacity:1;transform:scale(1)} }
        .modal-icon { width: 82px; height: 82px; border-radius: 50%; background: #d4f5e4; display: flex; align-items: center; justify-content: center; margin: 0 auto 22px; }
        .modal-icon i { font-size: 38px; color: #1a9e5a; }
        .modal-box h2 { font-size: 24px; font-weight: 800; color: #1a1a1a; margin-bottom: 10px; }
        .modal-box p { color: #999; font-size: 15px; line-height: 1.6; margin-bottom: 30px; }
        .modal-btn { background: var(--primary); color: #fff; border: none; padding: 13px 36px; border-radius: 50px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.3s; }
        .modal-btn:hover { transform: translateY(-2px); filter: drop-shadow(0 5px 15px rgba(235,103,83,0.4)); }

        /* skeleton */
        .skeleton { background: linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 8px; }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

        @media (max-width: 900px) { .checkout-grid { grid-template-columns: 1fr; } .summary-card { position: static; order: -1; } }
        @media (max-width: 600px) { .page-body { padding: 80px 14px 48px; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

        <nav id="navbar">
            <div class="logo-area">
                <a href="/"><h1>AfriStay</h1></a>
            </div>
    
            <div class="nav-wrapper" id="navWrapper">
                <i class="fa-solid fa-xmark menu-close" onclick="toggleMenu()"></i>
                <div class="nav-center">
                    <ul class="nav-links">
                        <li><a href="/" class = "active">Home</a></li>
                        <li><a href="/Listings">Listings</a></li>
                        <li><a href="/About">About</a></li>
                        <li><a href="/Contact">Contact</a></li>
                    </ul>
                </div>
                <div class="nav-right">
                    <a href="#" class="icon-link"><i class="fa-regular fa-heart"></i></a>
                    <a href="/Auth" id="auth-btn" class="signin-btn">Sign In</a> 
                </div>
            </div>
            <i class="fa-solid fa-bars menu-open" onclick="toggleMenu()"></i>
        </nav>

<div class="page-body">
    <div class="breadcrumb">
        <a href="/Listings"><i class="fa-solid fa-arrow-left"></i> Listings</a>
        <i class="fa-solid fa-chevron-right"></i>
        <a href="#" id="breadDetail">Listing</a>
        <i class="fa-solid fa-chevron-right"></i>
        <span>Checkout</span>
    </div>
    <div class="page-title">Complete Your Booking</div>
    <p class="page-sub">Fill in your details and choose how you'd like to pay.</p>

    <div class="checkout-grid">

        <!-- LEFT: FORMS -->
        <div>
            <!-- Your Details -->
            <div class="form-card">
                <h2><i class="fa-solid fa-user"></i> Your Details</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="guestName" placeholder="Shema Josue">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="guestPhone" placeholder="+250 781 000 000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="guestEmail" placeholder="you@email.com">
                </div>
            </div>

            <!-- Dates -->
            <div class="form-card">
                <h2><i class="fa-solid fa-calendar-days"></i> Booking Dates</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate" onchange="calcTotal()">
                        <p class="date-hint">Check-in / pickup date</p>
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="endDate" onchange="calcTotal()">
                        <p class="date-hint">Check-out / return date</p>
                    </div>
                </div>
            </div>

            <!-- Payment -->
            <div class="form-card">
                <h2><i class="fa-solid fa-credit-card"></i> Payment Method</h2>
                <div class="pay-options" id="payOptions">
                    <label class="pay-option selected" onclick="selectPay(this)">
                        <input type="radio" name="payment" value="momo" checked>
                        <div class="pay-icon momo"><i class="fa-solid fa-mobile-screen"></i></div>
                        <div class="pay-info">
                            <div class="pay-name">MTN Mobile Money</div>
                            <div class="pay-desc">Instant confirmation via MoMo</div>
                        </div>
                    </label>
                    <label class="pay-option" onclick="selectPay(this)">
                        <input type="radio" name="payment" value="airtel">
                        <div class="pay-icon airtel"><i class="fa-solid fa-sim-card"></i></div>
                        <div class="pay-info">
                            <div class="pay-name">Airtel Money</div>
                            <div class="pay-desc">Pay securely with Airtel Money</div>
                        </div>
                    </label>
                    <label class="pay-option" onclick="selectPay(this)">
                        <input type="radio" name="payment" value="cash">
                        <div class="pay-icon cash"><i class="fa-solid fa-money-bill-wave"></i></div>
                        <div class="pay-info">
                            <div class="pay-name">Pay on Arrival</div>
                            <div class="pay-desc">Cash payment at check-in</div>
                        </div>
                    </label>
                </div>

                <button class="submit-btn" id="submitBtn" onclick="submitBooking()">
                    <i class="fa-solid fa-lock"></i> Confirm Booking
                </button>
            </div>
        </div>

        <!-- RIGHT: SUMMARY -->
        <div>
            <div class="summary-card">
                <div class="summary-img-wrap" id="summaryImgWrap">
                    <i class="fa-solid fa-image" style="font-size:38px;color:#ddd;"></i>
                </div>
                <div class="summary-title" id="summaryTitle">
                    <div class="skeleton" style="height:16px;width:80%;margin-bottom:6px;"></div>
                </div>
                <div class="summary-loc" id="summaryLoc">
                    <div class="skeleton" style="height:12px;width:55%;"></div>
                </div>
                <div class="duration-badge" id="durationBadge" style="display:none;"></div>
                <div class="summary-divider"></div>
                <div class="summary-row"><span>Rate</span><span class="val" id="summaryRate">—</span></div>
                <div class="summary-row"><span>Duration</span><span class="val" id="summaryDuration">—</span></div>
                <div class="summary-divider"></div>
                <div class="summary-row total"><span>Total</span><span class="val" id="summaryTotal">—</span></div>
            </div>
        </div>
    </div>
</div>

<!-- SUCCESS MODAL -->
<div class="modal-overlay" id="successModal">
    <div class="modal-box">
        <div class="modal-icon"><i class="fa-solid fa-circle-check"></i></div>
        <h2>Booking Submitted!</h2>
        <p>Your booking request is pending owner approval. We'll notify you by email once it's confirmed.</p>
        <button class="modal-btn" onclick="window.location.href='/Listings'">Browse More Listings</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/config.js"></script>
<script src="/js/script.js"></script>
<script>
(async () => {
    const sb = window.supabaseClient;
    function esc(s) { return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // must be logged in
    let currentUser = null;
    try {
        const{data:{user}}=await sb.auth.getUser();
        if (!user) { alert('Please sign in to book.'); window.location.href='/auth.html'; return; }
        currentUser = user;
        document.getElementById('signInBtn').classList.add('hidden');
        document.getElementById('userIcon').classList.remove('hidden');
        document.getElementById('guestEmail').value = user.email||'';
        const{data:profile}=await sb.from('profiles').select('full_name,phone').eq('id',user.id).single();
        if(profile){ document.getElementById('guestName').value=profile.full_name||''; document.getElementById('guestPhone').value=profile.phone||''; }
    } catch(e){ window.location.href='/auth.html'; return; }

    const id = new URLSearchParams(window.location.search).get('id');
    if (!id) { alert('No listing selected.'); window.location.href='/Listings'; return; }

    const{data:L,error}=await sb.from('listings').select('id,title,price,currency,category_slug,availability_status,province_id,district_id').eq('id',id).single();
    if(error||!L||L.availability_status!=='available'){ alert('This listing is not available.'); window.location.href='/Listings'; return; }

    document.getElementById('breadDetail').href='/detail.html?id='+id;
    document.getElementById('breadDetail').textContent=L.title;
    document.getElementById('summaryTitle').textContent=L.title;
    const isVeh=L.category_slug==='vehicle'; const unit=isVeh?'day':'night';
    document.getElementById('summaryRate').textContent=Number(L.price).toLocaleString()+' '+(L.currency||'RWF')+'/'+ unit;

    // location
    const pvN={},dtN={};
    if(L.province_id){const{data:pv}=await sb.from('provinces').select('name').eq('id',L.province_id).single();if(pv)pvN.name=pv.name;}
    if(L.district_id){const{data:dt}=await sb.from('districts').select('name').eq('id',L.district_id).single();if(dt)dtN.name=dt.name;}
    const loc=[dtN.name,pvN.name].filter(Boolean).join(', ')||'Rwanda';
    document.getElementById('summaryLoc').innerHTML='<i class="fa-solid fa-location-dot"></i> '+esc(loc);

    // image
    const{data:imgs}=await sb.from('listing_images').select('image_url').eq('listing_id',id).limit(1);
    if(imgs&&imgs[0]){ document.getElementById('summaryImgWrap').innerHTML='<img src="'+esc(imgs[0].image_url)+'" alt="'+esc(L.title)+'">'; }

    // default dates
    const today=new Date().toISOString().split('T')[0];
    const tom=new Date(); tom.setDate(tom.getDate()+1);
    document.getElementById('startDate').min=today;
    document.getElementById('endDate').min=today;
    document.getElementById('startDate').value=today;
    document.getElementById('endDate').value=tom.toISOString().split('T')[0];

    window.calcTotal = () => {
        const s=document.getElementById('startDate').value;
        const e=document.getElementById('endDate').value;
        const badge=document.getElementById('durationBadge');
        if(!s||!e){document.getElementById('summaryDuration').textContent='—';document.getElementById('summaryTotal').textContent='—';badge.style.display='none';return;}
        const diff=Math.round((new Date(e)-new Date(s))/(1000*60*60*24));
        if(diff<=0){document.getElementById('summaryDuration').textContent='Invalid dates';document.getElementById('summaryTotal').textContent='—';return;}
        const total=diff*L.price;
        document.getElementById('summaryDuration').textContent=diff+' '+unit+(diff!==1?'s':'');
        document.getElementById('summaryTotal').textContent=total.toLocaleString()+' '+(L.currency||'RWF');
        badge.textContent=diff+' '+unit+(diff!==1?'s':'')+' selected';
        badge.style.display='inline-flex';
    };
    calcTotal();

    window.selectPay = (el) => {
        document.querySelectorAll('.pay-option').forEach(o=>o.classList.remove('selected'));
        el.classList.add('selected');
    };

    window.submitBooking = async () => {
        const name=document.getElementById('guestName').value.trim();
        const email=document.getElementById('guestEmail').value.trim();
        const start=document.getElementById('startDate').value;
        const end=document.getElementById('endDate').value;
        const payMethod=document.querySelector('input[name="payment"]:checked')?.value||'momo';

        if(!name||!email){ alert('Please fill in your name and email.'); return; }
        if(!start||!end){ alert('Please select your booking dates.'); return; }
        const diff=Math.round((new Date(end)-new Date(start))/(1000*60*60*24));
        if(diff<=0){ alert('End date must be after start date.'); return; }
        const total=diff*L.price;

        const btn=document.getElementById('submitBtn');
        btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

        try {
            const{data,error}=await sb.from('bookings').insert([{
                listing_id: id,
                user_id: currentUser.id,
                start_date: start,
                end_date: end,
                total_amount: total,
                status: 'pending',
                payment_method: payMethod
            }]).select().single();
            if(error) throw error;
            document.getElementById('successModal').classList.add('show');
        } catch(err) {
            console.error('Booking error', err);
            alert('Booking failed: '+(err.message||JSON.stringify(err)));
            btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-lock"></i> Confirm Booking';
        }
    };
})();
</script>
</body>
</html>
