# AfriStay ‚Äî Project Checklist

## ‚úÖ Done this session
- **Pending listing workflow** ‚Äî owner uploads ‚Üí `status='pending'`, invisible to public. Admin approves ‚Üí `status='approved'` ‚Üí live on /Listings and home
- **Public page filters** ‚Äî script.js and home.js now filter `status='approved'` AND `availability_status='available'`. Unapproved or unavailable listings never appear publicly
- **Dashboard "New Listings" widget** ‚Äî replaces old Recent Bookings on dashboard tab. Admin sees all pending with Approve/Reject. Owner sees their own pending with status badge
- **Detail page for pending listings** ‚Äî shows full listing info but replaces booking form with "Awaiting Approval" notice. Preview link (`?preview=1`) works from dashboard
- **Owner contact on detail page** ‚Äî fetches owner's full_name, email, phone and renders a "Contact Host" card above reviews
- **Client-side caching** ‚Äî `_cache` module in dashboard.js (TTL-based), `_locCache` in script.js (5 min), location lookups shared between pages. Image maps cached 2 min. Cache busted after create/approve/delete
- **Dashboard logo fix** ‚Äî `.logo-area img` CSS updated: proper `height:48px`, `max-width:180px`, bottom border separator, less vertical padding. Collapsed sidebar shows 36px logo

---

## üî≤ Remaining ‚Äî Priority Order

### üî¥ High Priority

#### Payment System
- [ ] Choose payment provider: **MTN Mobile Money** (Rwanda) or **Stripe** (cards)
  - MTN MoMo: needs MTN API credentials, webhook handler
  - Stripe: `stripe.js` + backend Edge Function to create PaymentIntent
- [ ] `/Checkout` page: payment method selection UI
- [ ] Edge Function: `create-payment-intent` or MoMo initiation
- [ ] Webhook handler: on payment success ‚Üí update booking `status='confirmed'`, `payment_status='paid'`
- [ ] Payment status shown on booking cards in dashboard
- [ ] Refund handling (admin can issue refund from dashboard)

#### Email Confirmations + Detailed Receipt
- [ ] EmailJS (already configured but keys are placeholder) ‚Üí fill real keys in config
- [ ] **Booking Request email** ‚Üí owner gets notified when someone books
- [ ] **Booking Approved email** ‚Üí guest gets confirmation + receipt PDF
- [ ] **Receipt content**: listing name, address, dates, nights, price/night, total, booking ID, owner contact, AfriStay branding
- [ ] Receipt PDF: upgrade `downloadReceipt()` in dashboard.js ‚Äî currently uses jsPDF but needs styling
- [ ] Add "Download Receipt" button to guest's booking card

### üü° Medium Priority

#### Listing Management
- [ ] Owner can **edit** a listing (title, description, price, images, availability) ‚Äî currently no edit form
- [ ] Owner can **delete** their own listing
- [ ] Image upload UX: drag-and-drop zone, preview before submit, re-order images
- [ ] Video upload: currently supported in schema but UX is basic

#### Booking Flow
- [ ] **Date conflict checking** ‚Äî prevent double-booking: before creating booking, check if listing has overlapping approved booking
- [ ] Auto-cancel: 3-hour countdown for unconfirmed bookings (pg_cron already set up per prev session)
- [ ] Countdown timer visible on guest's pending booking card

#### Search & Filters
- [ ] `/Listings` page: add **price range** filter (min/max inputs)
- [ ] `/Listings` page: add **category** filter (real estate vs vehicle)
- [ ] `/Listings` page: sort options (price ‚Üë‚Üì, newest, rating)
- [ ] Search: full-text search across title + description (Supabase `fts` or `websearch_to_tsquery`)

### üü¢ Lower Priority

#### Reviews
- [ ] Review gating: only guests with a **completed** booking can leave a review (currently open to all)
  - DB trigger `validate_review` already exists ‚Äî just needs enabling

#### Events
- [ ] Event RSVP / attendance tracking
- [ ] Events: share button (copy link, social)
- [ ] Event images: gallery with swipe on mobile

#### Promotions
- [ ] Promotion conflict check: prevent two active promos for same listing at same time
- [ ] Dashboard promotion stats: "X bookings used this promo"

#### UX / Polish
- [ ] Skeleton loaders on `/Listings` and `/Events` pages (currently just spinner)
- [ ] 404 page for invalid listing/event IDs
- [ ] SEO: `<meta og:image>` populated from listing's first image
- [ ] PWA manifest: add to home screen on mobile
- [ ] Dark mode (optional)

#### Admin
- [ ] Admin can **reassign** listing owner
- [ ] Admin bulk actions: approve all pending, bulk delete
- [ ] Revenue chart (bar/line) on admin dashboard with monthly breakdown
- [ ] Export bookings to CSV

---

## üóÑÔ∏è SQL Still Needed

```sql
-- Run migration.sql first (attached), then:

-- Date conflict check (call from JS before inserting booking)
CREATE OR REPLACE FUNCTION check_booking_conflict(
    p_listing_id UUID, p_start DATE, p_end DATE, p_exclude_id UUID DEFAULT NULL
) RETURNS BOOLEAN AS $$
    SELECT EXISTS (
        SELECT 1 FROM bookings
        WHERE listing_id = p_listing_id
          AND status IN ('pending','approved','confirmed')
          AND (p_exclude_id IS NULL OR id != p_exclude_id)
          AND start_date < p_end
          AND end_date > p_start
    );
$$ LANGUAGE SQL STABLE;
```

---

## üìÇ Deployment Order (this session)

1. Run `migration.sql` in Supabase SQL Editor
2. Deploy `dashboard.css` ‚Üí `/Style/dashboard.css`
3. Deploy `dashboard.js` ‚Üí `/js/dashboard.js`
4. Deploy `detail.js` ‚Üí `/js/detail.js`
5. Deploy `script.js` ‚Üí `/js/script.js`
6. Deploy `home.js` ‚Üí `/js/home.js`
7. Verify: Create a test listing as owner ‚Üí should appear in dashboard "New Listings" pending widget ‚Üí admin approves ‚Üí appears on /Listings